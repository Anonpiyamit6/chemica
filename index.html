
<!DOCTYPE html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartLab Chemical Inventory System</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
            min-height: 100%;
            line-height: 1.6;
        }
        
        * {
            box-sizing: border-box;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            min-height: 100%;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100%;
            padding: 20px;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 420px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .logo-container {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 20px;
        }

        h1 {
            color: #1f2937;
            margin: 0 0 8px 0;
            font-size: 26px;
            text-align: center;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .subtitle {
            color: #6b7280;
            text-align: center;
            margin-bottom: 32px;
            font-size: 15px;
            line-height: 1.5;
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }

        .input-wrapper {
            position: relative;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            font-family: inherit;
        }

        input[type="password"] {
            padding-right: 48px;
        }

        .eye-icon {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 18px;
            color: #6b7280;
            user-select: none;
            transition: color 0.2s;
        }

        .eye-icon:hover {
            color: #374151;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #93c5fd;
            box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.1);
            background: white;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(147, 197, 253, 0.3);
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(147, 197, 253, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
            margin: 0 4px;
            border-radius: 10px;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 14px;
            text-align: center;
            border: 1px solid #fecaca;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 20px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(147, 197, 253, 0.3);
        }

        .header-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 14px;
        }

        .header-info h2 {
            margin: 0;
            color: #1f2937;
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .header-info p {
            margin: 4px 0 0 0;
            color: #6b7280;
            font-size: 14px;
            font-weight: 400;
        }

        .header-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .nav-tabs {
            display: flex;
            gap: 6px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 8px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            flex-wrap: wrap;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .nav-tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-family: inherit;
        }

        .nav-tab:hover {
            background: rgba(147, 197, 253, 0.1);
            color: #60a5fa;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(147, 197, 253, 0.3);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card h3 {
            margin: 0 0 12px 0;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: 700;
            color: #60a5fa;
            margin: 0;
            background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .card h3 {
            margin: 0 0 20px 0;
            color: #1f2937;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .search-box input:focus {
            outline: none;
            border-color: #93c5fd;
            box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.1);
            background: white;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: white;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 700px;
            background: white;
            font-size: 13px;
            border-radius: 16px;
            overflow: hidden;
        }

        th {
            background: #93c5fd;
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            color: white;
            border: none;
            font-size: 13px;
            letter-spacing: 0.2px;
            position: relative;
        }

        th:first-child {
            border-top-left-radius: 16px;
        }

        th:last-child {
            border-top-right-radius: 16px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
            font-weight: 400;
            background: white;
            transition: all 0.2s ease;
            font-size: 13px;
        }

        tr:hover td {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: scale(1.001);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:last-child td:first-child {
            border-bottom-left-radius: 16px;
        }

        tr:last-child td:last-child {
            border-bottom-right-radius: 16px;
        }

        /* Academic table styling */
        .academic-table {
            box-shadow: 0 12px 40px rgba(147, 197, 253, 0.1);
        }

        .academic-table th {
            background: #93c5fd;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .academic-table tbody tr:nth-child(even) td {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .academic-table tbody tr:hover td {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            box-shadow: 0 4px 12px rgba(147, 197, 253, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.25px;
        }

        .badge-low {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .badge-normal {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: #60a5fa;
            border: 1px solid #bfdbfe;
        }

        .badge-pending {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            color: #d97706;
            border: 1px solid #fed7aa;
        }

        .badge-returned {
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
            color: #a16207;
            border: 1px solid #fed7aa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: 20px;
            max-width: 560px;
            width: 100%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            margin: 0;
            color: #1f2937;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .close-btn {
            background: rgba(107, 114, 128, 0.1);
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: rgba(107, 114, 128, 0.2);
            color: #374151;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
            font-size: 14px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Academic styling improvements */
        .academic-header {
            background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 16px 16px 0 0;
            margin: -24px -24px 20px -24px;
        }

        .academic-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
            margin: 24px 0;
        }

        .info-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bfdbfe;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .info-box p {
            margin: 0;
            color: #60a5fa;
            font-size: 14px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 16px 20px;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .nav-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding: 6px;
            }

            .nav-tab {
                white-space: nowrap;
                padding: 8px 16px;
                font-size: 13px;
            }

            .modal-content {
                padding: 24px;
                margin: 10px;
            }

            .login-box {
                padding: 32px 24px;
                margin: 10px;
            }

            h1 {
                font-size: 22px;
            }

            .card {
                padding: 20px;
            }

            table {
                min-width: 600px;
            }

            th, td {
                padding: 10px 6px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .btn-small {
                padding: 6px 12px;
                font-size: 12px;
                margin: 2px;
            }

            .stats-grid {
                gap: 12px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-card .number {
                font-size: 28px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="app"></div>
  <script>
  // --- Global App State ---
  const defaultConfig = {
    system_title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£',
    logo_url: '',
    welcome_message: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤'
  };
  let currentUser = null;
  let allData = [];
  let currentView = 'login';
  let currentTab = 'dashboard';

  // --- Element Cache ---
  let appElement;
  let modalElement;
  let loginButtonElement;
  let loginErrorElement;

  // --- App Initialization ---
  document.addEventListener('DOMContentLoaded', init);

  function init() {
    console.log('App initializing...');
    appElement = document.getElementById('app');
    
    appElement.innerHTML = `<div class="login-container"><div class="login-box" style="text-align: center;"><h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h2></div></div>`;
    
    google.script.run
      .withSuccessHandler(onSyncSuccess)
      .withFailureHandler(onFailure)
      .handleSync({}); 
  }

  function onSyncSuccess(response) {
    if (response.success && response.data) {
      allData = response.data;
      console.log('Data Synced:', allData.length);
      initializeDefaultAdmin();
    } else {
      onFailure(new Error('Failed to sync data or no data returned.'));
    }
  }
  
  /**
   * [GAS CONVERSION] ‡πÄ‡∏°‡∏∑‡πà‡∏≠ C-U-D (‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï/‡∏•‡∏ö) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
   */
  function onCrudSuccess(response) {
    if (!response.success) {
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡∏à‡∏≤‡∏Å backend
      const specificError = response.message || 'CRUD operation failed';
      showErrorMessage(specificError); 
      onFailure(new Error(specificError)); // Log to console and reset buttons
      return;
    }
    
    console.log('CRUD Success:', response.action);
    
    // --- [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô allData (‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á) ---
    if (response.action === 'create') {
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Array
      allData.push(response.data);
    } 
    else if (response.action === 'update') {
      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
      const index = allData.findIndex(i => i.__backendId === response.data.__backendId);
      if (index > -1) {
        // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
        allData[index] = response.data; 
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠) ‡∏Å‡πá‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
        allData.push(response.data);
      }
    } 
    else if (response.action === 'delete') {
      // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Array
      allData = allData.filter(i => i.__backendId !== response.id);
    }
    
    closeModal();
    renderDashboard(); // <-- [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    
    // refreshData(); // <-- [‡∏•‡∏ö] ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß!
  }
  function onBorrowSuccess(response) {
      if (!response.success) {
        return onFailure(new Error(response.message || 'Borrow operation failed'));
      }
      
      console.log('Borrow Success:', response.action);
      
      // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° borrow record ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô allData
      allData.push(response.borrow);
      
      // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï item stock ‡πÉ‡∏ô allData
      const index = allData.findIndex(i => i.__backendId === response.item.__backendId);
      if (index > -1) {
        allData[index] = response.item; // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤
      } else {
        allData.push(response.item); // (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ)
      }

      closeModal();
      
      // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏ó‡πá‡∏ö '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°' ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      currentTab = 'borrow';
      
      renderDashboard(); // <-- ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏î‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö 'borrow'
    }

  /**
   * [GAS CONVERSION] ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà
   */
  function refreshData() {
    console.log('Refreshing data...');
    // TODO: ‡πÅ‡∏™‡∏î‡∏á loading spinner
    google.script.run
      .withSuccessHandler((response) => {
        if (response.success && response.data) {
          allData = response.data;
          console.log('Data Refreshed:', allData.length);
          renderDashboard(); // ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
          // TODO: ‡∏ã‡πà‡∏≠‡∏ô loading spinner
        } else {
          onFailure(new Error('Failed to refresh data.'));
        }
      })
      .withFailureHandler(onFailure)
      .handleSync({});
  }

  /**
   * [GAS CONVERSION] ‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á
   */
  function onFailure(error) {
    console.error('Google Script Error:', error);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error
    const errorBox = loginErrorElement || document.querySelector('.error-toast');
    if (errorBox && !document.querySelector('.error-toast')) {
         showErrorMessage(error.message);
    }
    
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const modalSubmitBtn = document.querySelector('.modal-content button[type="submit"]');
    if (modalSubmitBtn) {
        modalSubmitBtn.disabled = false;
        modalSubmitBtn.textContent = modalSubmitBtn.dataset.originalText || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    }
    if(loginButtonElement) {
        loginButtonElement.disabled = false;
        loginButtonElement.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
    }
  }

  // --- CRUD Functions (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å UI) ---

  function createItem(data) {
    console.log('Creating item...', data);
    google.script.run
      .withSuccessHandler(onCrudSuccess)
      .withFailureHandler(onFailure)
      .handleCreate(data);
  }

  function updateItem(data) {
    console.log('Updating item...', data);
    google.script.run
      .withSuccessHandler(onCrudSuccess)
      .withFailureHandler(onFailure)
      .handleUpdate(data);
  }
  
  /**
   * [GAS CONVERSION] ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô deleteItem (‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡∏¥‡∏î Modal) ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
   * ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô deleteItem ‡πÄ‡∏î‡∏¥‡∏°
   */
  function deleteItem(backendId) {
    const item = allData.find(i => i.__backendId === backendId);
    if (!item) return;

    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
          <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <div style="text-align: center; padding: 20px 0;">
          <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
          <p style="margin-bottom: 24px; color: #6b7280; font-size: 16px;">
            ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "<strong>${item.name || item.username}</strong>" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?<br>
            <small>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ</small>
          </p>
        </div>
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete('${backendId}')">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
      </div>
    `;
    modalElement.classList.add('active');
  }

  /**
   * [GAS CONVERSION] ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô confirmDelete (‡∏ï‡∏±‡∏ß logic) ‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß
   */
  function confirmDelete(backendId) {
    const btn = document.getElementById('confirmDeleteBtn');
    if(btn) {
        btn.disabled = true;
        btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
    }
    // onCrudSuccess ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞ Refresh ‡πÄ‡∏≠‡∏á
    google.script.run
      .withSuccessHandler(onCrudSuccess)
      .withFailureHandler(onFailure)
      .handleDelete({ id: backendId });
  }
  
  // --- Original Functions (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß) ---

  async function initializeDefaultAdmin() {
    const adminExists = allData.find(item =>
      item.type === 'user' && item.username === 'admin'
    );

    if (!adminExists) {
      console.log('Admin user not found, creating...');
      const adminData = {
        id: 'admin-' + Date.now(),
        type: 'user',
        username: 'admin',
        password: 'admin123',
        role: 'admin',
        createdAt: new Date().toISOString()
      };
      
      google.script.run
        .withSuccessHandler(onAdminCreated)
        .withFailureHandler(onFailure)
        .handleCreate(adminData);
    } else {
      renderLogin();
    }
  }
  
  function onAdminCreated(response) {
    if (!response.success) {
      return onFailure(new Error('Failed to create admin user.'));
    }
    console.log('Admin user created. Re-syncing...');
    google.script.run
      .withSuccessHandler((syncResponse) => {
        if (syncResponse.success && syncResponse.data) {
          allData = syncResponse.data;
          console.log('Data Synced post-admin creation:', allData.length);
          renderLogin();
        } else {
          onFailure(new Error('Failed to sync after admin creation.'));
        }
      })
      .withFailureHandler(onFailure)
      .handleSync({});
  }

  function renderLogin() {
    currentView = 'login';
    const title = defaultConfig.system_title;
    const logoUrl = defaultConfig.logo_url;
    const welcomeMsg = defaultConfig.welcome_message;

    appElement.innerHTML = `
      <div class="login-container">
        <div class="login-box">
          <div class="logo-container">
            <div class="logo">
              ${logoUrl ? `<img src="${logoUrl}" alt="Logo">` : 'üß™'}
            </div>
            <h1 class="system-title">${title}</h1>
            <p class="subtitle">${welcomeMsg}</p>
          </div>
          <div id="loginError"></div>
          <form id="loginForm">
            <div class="form-group">
              <label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
              <input type="text" id="username" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" value="admin">
            </div>
            <div class="form-group">
              <label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
              <div class="input-wrapper">
                <input type="password" id="password" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" value="admin123">
                <span class="eye-icon" onclick="togglePassword()">üëÅÔ∏è</span>
              </div>
            </div>
            <button type="submit" id="loginButton" class="btn btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
          </form>
          <div class="info-box" style="margin-top: 20px;">
    <p style="text-align: center; white-space: nowrap; font-size: 13px;">
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ | ‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß
    </p>
</div>
        </div>
      </div>
    `;

    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    loginButtonElement = document.getElementById('loginButton');
    loginErrorElement = document.getElementById('loginError');
  }

  function togglePassword() {
    const passwordInput = document.getElementById('password');
    const eyeIcon = document.querySelector('.eye-icon');
    if (!passwordInput || !eyeIcon) return;
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      eyeIcon.textContent = 'üôà';
    } else {
      passwordInput.type = 'password';
      eyeIcon.textContent = 'üëÅÔ∏è';
    }
  }

  async function handleLogin(e) {
    e.preventDefault();
    if(loginButtonElement) {
      loginButtonElement.disabled = true;
      loginButtonElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
    }
    if(loginErrorElement) loginErrorElement.innerHTML = '';
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    google.script.run
      .withSuccessHandler(onLoginSuccess)
      .withFailureHandler(onFailure)
      .handleLogin({ username: username, password: password });
  }
  
  function onLoginSuccess(response) {
    if(loginButtonElement) {
      loginButtonElement.disabled = false;
      loginButtonElement.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
    }

    if (response.success && response.user) {
      currentUser = response.user;
      currentView = currentUser.role === 'admin' ? 'admin' : 'teacher';
      currentTab = 'dashboard';
      
      // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÅ‡∏™‡∏î‡∏á Loading ‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      appElement.innerHTML = `<div class="login-container"><div class="login-box" style="text-align: center;"><h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h2><p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${currentUser.username}</p></div></div>`;
      
      google.script.run
          .withSuccessHandler(onLoginSyncSuccess) // <-- [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ Handler ‡πÉ‡∏´‡∏°‡πà
          .withFailureHandler(onFailure)
          .handleSync({}); 

      // renderDashboard(); // <-- [‡∏•‡∏ö] ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    } else {
      if(loginErrorElement) {
        loginErrorElement.innerHTML =
          '<div class="error-message">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>';
      }
    }
  }

  function onLoginSyncSuccess(response) {
    if (response.success && response.data) {
      allData = response.data;
      console.log('Data Synced Post-Login:', allData.length);
      renderDashboard(); // <-- [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏ß‡∏≤‡∏î Dashboard ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
    } else {
      onFailure(new Error('Failed to sync data after login.'));
    }
  }

  function renderDashboard() {
    if (!appElement) appElement = document.getElementById('app');
    const title = defaultConfig.system_title;
    const logoUrl = defaultConfig.logo_url;

    if (currentUser.role === 'admin') {
      renderAdminDashboard(title, logoUrl);
    } else {
      renderTeacherDashboard(title, logoUrl);
    }
    modalElement = document.getElementById('modal');
  }

  function renderAdminDashboard(title, logoUrl) {
    const chemicals = allData.filter(item => item.type === 'chemical');
    const equipment = allData.filter(item => item.type === 'equipment');
    const users = allData.filter(item => item.type === 'user' && item.role === 'teacher');
    const borrows = allData.filter(item => item.type === 'borrow');
    const lowStock = chemicals.filter(item => item.quantity <= (item.minStock || 0));

    appElement.innerHTML = `
      <div class="container">
        <div class="header">
          <div class="header-left">
            <div class="header-logo">${logoUrl ? `<img src="${logoUrl}" alt="Logo">` : 'üß™'}</div>
            <div class="header-info">
              <h2 class="system-title">${title}</h2>
              <p>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö: ${currentUser.username}</p>
            </div>
          </div>
          <div class="header-right"><button class="btn btn-secondary btn-small" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div>
        </div>
        <div class="nav-tabs">
          <button class="nav-tab ${currentTab === 'dashboard' ? 'active' : ''}" onclick="switchTab('dashboard')">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
          <button class="nav-tab ${currentTab === 'chemicals' ? 'active' : ''}" onclick="switchTab('chemicals')">üß¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</button>
          <button class="nav-tab ${currentTab === 'equipment' ? 'active' : ''}" onclick="switchTab('equipment')">üî¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
          <button class="nav-tab ${currentTab === 'users' ? 'active' : ''}" onclick="switchTab('users')">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
          <button class="nav-tab ${currentTab === 'reports' ? 'active' : ''}" onclick="switchTab('reports')">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
        </div>
        <div id="dashboardSection" class="content-section ${currentTab === 'dashboard' ? 'active' : ''}">
          <div class="stats-grid">
            <div class="stat-card"><h3>‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${chemicals.length}</p></div>
            <div class="stat-card"><h3>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${equipment.length}</p></div>
            <div class="stat-card"><h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3><p class="number">${users.length}</p></div>
            <div class="stat-card"><h3>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</h3><p class="number" style="color: #dc2626;">${lowStock.length}</p></div>
          </div>
          ${lowStock.length > 0 ? `
            <div class="card">
              <div class="academic-header"><h3>‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</h3></div>
              <div class="table-container">
                <table>
                  <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th></tr></thead>
                  <tbody>
                    ${lowStock.map(item => `
                      <tr>
                        <td><strong>${item.name}</strong></td>
                        <td>${item.formula || '-'}</td>
                        <td><span class="badge badge-low">${item.quantity} ${item.unit}</span></td>
                        <td>${item.minStock || 0} ${item.unit}</td>
                        <td>${item.location}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          ` : ''}
        </div>
        <div id="chemicalsSection" class="content-section ${currentTab === 'chemicals' ? 'active' : ''}">${renderChemicalsSection()}</div>
        <div id="equipmentSection" class="content-section ${currentTab === 'equipment' ? 'active' : ''}">${renderEquipmentSection()}</div>
        <div id="usersSection" class="content-section ${currentTab === 'users' ? 'active' : ''}">${renderUsersSection()}</div>
        <div id="reportsSection" class="content-section ${currentTab === 'reports' ? 'active' : ''}">${renderReportsSection()}</div>
      </div>
      <div id="modal" class="modal"></div>
    `;
  }

  function renderChemicalsSection() {
    const chemicals = allData.filter(item => item.type === 'chemical');
    return `
      <div class="card">
        <div class="academic-header"><h3>üß¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h3></div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <div class="info-box" style="flex: 1; margin: 0;"><p>üìã ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${chemicals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>
          <button class="btn btn-primary btn-small" onclick="openAddChemicalModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</button>
        </div>
        <div class="search-box"><input type="text" id="chemicalSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ (‡∏ä‡∏∑‡πà‡∏≠, ‡∏™‡∏π‡∏ï‡∏£, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö)..." onkeyup="filterChemicals()"></div>
        <div class="table-container academic-table">
          <table id="chemicalsTable">
            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>
              ${chemicals.length > 0 ? chemicals.map(item => `
                <tr>
                  <td><strong>${item.name}</strong></td>
                  <td>${item.formula || '-'}</td>
                  <td><span class="badge ${item.quantity <= (item.minStock || 0) ? 'badge-low' : 'badge-normal'}">${item.quantity}</span></td>
                  <td>${item.unit}</td>
                  <td>${item.location}</td>
                  <td>${item.minStock || 0}</td>
                  <td>
                    <button class="btn btn-secondary btn-small" onclick='editChemical(${JSON.stringify(item)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-danger btn-small" onclick='deleteItem("${item.__backendId}")'>‡∏•‡∏ö</button>
                  </td>
                </tr>
              `).join('') : '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìã</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ<br><small>‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</small></td></tr>'}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  function renderEquipmentSection() {
    const equipment = allData.filter(item => item.type === 'equipment');
    return `
      <div class="card">
        <div class="academic-header"><h3>üî¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3></div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <div class="info-box" style="flex: 1; margin: 0;"><p>üìã ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${equipment.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>
          <button class="btn btn-primary btn-small" onclick="openAddEquipmentModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
        </div>
        <div class="search-box"><input type="text" id="equipmentSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏ä‡∏∑‡πà‡∏≠, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö)..." onkeyup="filterEquipment()"></div>
        <div class="table-container academic-table">
          <table id="equipmentTable">
            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>
              ${equipment.length > 0 ? equipment.map(item => `
                <tr>
                  <td><strong>${item.name}</strong></td>
                  <td><span class="badge ${item.quantity <= (item.minStock || 0) ? 'badge-low' : 'badge-normal'}">${item.quantity}</span></td>
                  <td>${item.unit}</td>
                  <td>${item.location}</td>
                  <td>${item.minStock || 0}</td>
                  <td>
                    <button class="btn btn-secondary btn-small" onclick='editEquipment(${JSON.stringify(item)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-danger btn-small" onclick='deleteItem("${item.__backendId}")'>‡∏•‡∏ö</button>
                  </td>
                </tr>
              `).join('') : '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üî¨</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå<br><small>‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</small></td></tr>'}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  function renderUsersSection() {
    const users = allData.filter(item => item.type === 'user' && item.role === 'teacher');
    return `
      <div class="card">
        <div class="academic-header"><h3>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3></div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <div class="info-box" style="flex: 1; margin: 0;"><p>üë®‚Äçüè´ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${users.length} ‡∏Ñ‡∏ô</p></div>
          <button class="btn btn-primary btn-small" onclick="openAddUserModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
        </div>
        <div class="table-container academic-table">
          <table>
            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th><th>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>
              ${users.length > 0 ? users.map(item => `
                <tr>
                  <td><strong>${(item.firstName || '') + ' ' + (item.lastName || '')}</strong></td>
                  <td>${item.username}</td>
                  <td>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                  <td><span class="badge badge-normal">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</span></td>
                  <td>
                    <button class="btn btn-secondary btn-small" onclick='editUser(${JSON.stringify(item)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-danger btn-small" onclick='deleteItem("${item.__backendId}")'>‡∏•‡∏ö</button>
                  </td>
                </tr>
              `).join('') : '<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">üë•</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ<br><small>‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</small></td></tr>'}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  function renderReportsSection() {
    const borrows = allData.filter(item => item.type === 'borrow');
    const pending = borrows.filter(item => item.status === 'pending');
    const returned = borrows.filter(item => item.status === 'returned');
    const chemicals = allData.filter(item => item.type === 'chemical');
    const equipment = allData.filter(item => item.type === 'equipment');
    const issueReportsChemical = allData.filter(item => item.type === 'issue_report' && item.issueType === 'out_of_stock');
    const issueReportsEquipment = allData.filter(item => item.type === 'issue_report' && item.issueType === 'damaged');

    return `
      <div class="card">
        <div class="academic-header"><h3>üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</h3></div>
        <div class="stats-grid" style="margin-bottom: 20px;">
          <div class="stat-card"><h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${borrows.length}</p></div>
          <div class="stat-card"><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô</h3><p class="number" style="color: #d97706;">${pending.length}</p></div>
          <div class="stat-card"><h3>‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h3><p class="number" style="color: #059669;">${returned.length}</p></div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <div class="search-box" style="flex: 1; margin: 0;"><input type="text" id="reportSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°, ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏´‡πâ‡∏≠‡∏á)..." onkeyup="filterReports()"></div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-success btn-small" onclick="downloadBorrowReport('excel')">üìä Excel</button>
            <button class="btn btn-danger btn-small" onclick="downloadBorrowReport('pdf')">üìÑ PDF</button>
          </div>
        </div>
        <div class="table-container academic-table">
          <table id="reportsTable">
            <thead><tr><th>‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
            <tbody>
              ${borrows.length > 0 ? borrows.map(item => `
                <tr>
                  <td><strong>${item.borrower}</strong></td>
                  <td>${item.itemName}</td>
                  <td>${item.amount}</td>
                  <td>${item.room}</td>
                  <td>${new Date(item.borrowDate).toLocaleDateString('th-TH')}</td>
                  <td>${item.returnDate ? new Date(item.returnDate).toLocaleDateString('th-TH') : '-'}</td>
                  <td><span class="badge ${item.status === 'returned' ? 'badge-returned' : 'badge-pending'}">${item.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô'}</span></td>
                </tr>
              `).join('') : '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìà</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</td></tr>'}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="academic-header"><h3>üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3></div>
        <div class="stats-grid" style="margin-bottom: 20px;">
          <div class="stat-card"><h3>‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${chemicals.length}</p></div>
          <div class="stat-card"><h3>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${equipment.length}</p></div>
          <div class="stat-card"><h3>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</h3><p class="number" style="color: #d97706;">${[...chemicals, ...equipment].filter(item => item.quantity <= (item.minStock || 0)).length}</p></div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 20px;">
          <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #bfdbfe; padding: 16px; border-radius: 12px;">
            <h4 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-success btn-small" onclick="downloadInventoryReport('all', 'excel')">üìä Excel</button>
              <button class="btn btn-danger btn-small" onclick="downloadInventoryReport('all', 'pdf')">üìÑ PDF</button>
            </div>
          </div>
          <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; padding: 16px; border-radius: 12px;">
            <h4 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h4>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-success btn-small" onclick="downloadInventoryReport('available', 'excel')">üìä Excel</button>
              <button class="btn btn-danger btn-small" onclick="downloadInventoryReport('available', 'pdf')">üìÑ PDF</button>
            </div>
          </div>
          <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; padding: 16px; border-radius: 12px;">
            <h4 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</h4>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-success btn-small" onclick="downloadInventoryReport('reorder', 'excel')">üìä Excel</button>
              <button class="btn btn-danger btn-small" onclick="downloadInventoryReport('reorder', 'pdf')">üìÑ PDF</button>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="academic-header"><h3>üß¨ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î</h3></div>
        <div style="margin-bottom: 20px;">
          <div class="info-box"><p>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π: ${issueReportsChemical.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>
        </div>
        <div class="table-container academic-table">
          <table>
            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>
              ${issueReportsChemical.length > 0 ? issueReportsChemical.map(report => `
                <tr>
                  <td><strong>${report.itemName}</strong></td>
                  <td>${report.reportedBy}</td>
                  <td>${new Date(report.reportDate).toLocaleDateString('th-TH')}</td>
                  <td>${report.originalAmount}</td>
                  <td>${report.note || '-'}</td>
                  <td><span class="badge ${report.status === 'resolved' ? 'badge-returned' : 'badge-pending'}">${report.status === 'resolved' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</span></td>
                  <td>
                    ${report.status !== 'resolved' ? `
                      <button class="btn btn-secondary btn-small" onclick='resolveChemicalIssue(${JSON.stringify(report)}, ${JSON.stringify(allData.find(i => i.__backendId === report.itemId))})'>‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                      <button class="btn btn-success btn-small" onclick='markIssueResolved(${JSON.stringify(report)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</button>
                    ` : '<span style="color: #9ca3af;">-</span>'}
                  </td>
                </tr>
              `).join('') : '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">‚úÖ</div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î<br><small>‡∏Ñ‡∏£‡∏π‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î</small></td></tr>'}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="academic-header"><h3>üî¨ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î</h3></div>
        <div style="margin-bottom: 20px;">
          <div class="info-box"><p>üîß ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π: ${issueReportsEquipment.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>
        </div>
        <div class="table-container academic-table">
          <table>
            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>
              ${issueReportsEquipment.length > 0 ? issueReportsEquipment.map(report => `
                <tr>
                  <td><strong>${report.itemName}</strong></td>
                  <td>${report.reportedBy}</td>
                  <td>${new Date(report.reportDate).toLocaleDateString('th-TH')}</td>
                  <td><span class="badge badge-low">${report.damagedAmount}</span></td>
                  <td>${report.note || '-'}</td>
                  <td><span class="badge ${report.status === 'resolved' ? 'badge-returned' : 'badge-pending'}">${report.status === 'resolved' ? '‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß' : '‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°'}</span></td>
                  <td>
                    ${report.status !== 'resolved' ? `
                      <button class="btn btn-secondary btn-small" onclick='viewEquipmentDetails("${report.itemId}")'>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                      <button class="btn btn-success btn-small" onclick='resolveEquipmentIssue(${JSON.stringify(report)}, ${JSON.stringify(allData.find(i => i.__backendId === report.itemId))})'>‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</button>
                    ` : '<span style="color: #9ca3af;">-</span>'}
                  </td>
                </tr>
              `).join('') : '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">‚úÖ</div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î<br><small>‡∏Ñ‡∏£‡∏π‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î</small></td></tr>'}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  function renderTeacherDashboard(title, logoUrl) {
    const chemicals = allData.filter(item => item.type === 'chemical');
    const equipment = allData.filter(item => item.type === 'equipment');
    const myBorrows = allData.filter(item => item.type === 'borrow' && item.borrower === currentUser.username);
    const pendingBorrows = myBorrows.filter(item => item.status === 'pending');

    // ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° ‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏Å‡∏•‡∏∏‡πà‡∏°
    const myChemicalBorrows = myBorrows.filter(item => item.itemType === 'chemical');
    const myEquipmentBorrows = myBorrows.filter(item => item.itemType === 'equipment');

    appElement.innerHTML = `
      <div class="container">
        <div class="header">
          <div class="header-left">
            <div class="header-logo">${logoUrl ? `<img src="${logoUrl}" alt="Logo">` : 'üß™'}</div>
            <div class="header-info">
              <h2 class="system-title">${title}</h2>
              <p>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${currentUser.username}</p>
            </div>
          </div>
          <div class="header-right"><button class="btn btn-secondary btn-small" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div>
        </div>
        <div class="nav-tabs">
          <button class="nav-tab ${currentTab === 'dashboard' ? 'active' : ''}" onclick="switchTab('dashboard')">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
          <button class="nav-tab ${currentTab === 'borrow' ? 'active' : ''}" onclick="switchTab('borrow')">üìù ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</button>
          <button class="nav-tab ${currentTab === 'history' ? 'active' : ''}" onclick="switchTab('history')">üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        </div>
        
        <div id="dashboardSection" class="content-section ${currentTab === 'dashboard' ? 'active' : ''}">
          <div class="stats-grid">
            <div class="stat-card"><h3>‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</h3><p class="number">${chemicals.length}</p></div>
            <div class="stat-card"><h3>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</h3><p class="number">${equipment.length}</p></div>
            <div class="stat-card"><h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</h3><p class="number">${myBorrows.length}</p></div>
            <div class="stat-card"><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô</h3><p class="number" style="color: #d97706;">${pendingBorrows.length}</p></div>
          </div>
          <div class="card">
            <div class="academic-header"><h3>üß¨ ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3></div>
            <div class="search-box"><input type="text" id="chemicalSearchTeacher" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ..." onkeyup="filterTeacherChemicals()"></div>
            <div class="table-container academic-table">
              <table id="teacherChemicalsTable">
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th><th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody>
                  ${chemicals.length > 0 ? chemicals.map(item => `
                    <tr>
                      <td><strong>${item.name}</strong></td>
                      <td>${item.formula || '-'}</td>
                      <td><span class="badge ${item.quantity <= (item.minStock || 0) ? 'badge-low' : 'badge-normal'}">${item.quantity} ${item.unit}</span></td>
                      <td>${item.location}</td>
                      <td>
                        ${item.quantity > 0 ? `
                          <button class="btn btn-primary btn-small" onclick='quickBorrowChemical(${JSON.stringify(item)})'>‡∏¢‡∏∑‡∏°</button>
                        ` : `
                          <button class="btn btn-danger btn-small" onclick='reportOutOfStock(${JSON.stringify(item)})'>‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î</button>
                        `}
                      </td>
                    </tr>
                  `).join('') : '<tr><td colspan="5" class="empty-state">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <div class="academic-header"><h3>üî¨ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3></div>
            <div class="search-box"><input type="text" id="equipmentSearchTeacher" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå..." onkeyup="filterTeacherEquipment()"></div>
            <div class="table-container academic-table">
              <table id="teacherEquipmentTable">
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th><th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody>
                  ${equipment.length > 0 ? equipment.map(item => `
                    <tr>
                      <td><strong>${item.name}</strong></td>
                      <td><span class="badge ${item.quantity <= (item.minStock || 0) ? 'badge-low' : 'badge-normal'}">${item.quantity} ${item.unit}</span></td>
                      <td>${item.location}</td>
                      <td>
                        ${item.quantity > 0 ? `
                          <button class="btn btn-primary btn-small" onclick='quickBorrowEquipment(${JSON.stringify(item)})'>‡∏¢‡∏∑‡∏°</button>
                        ` : `
                          <button class="btn btn-danger btn-small" onclick='reportDamaged(${JSON.stringify(item)})'>‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î</button>
                        `}
                      </td>
                    </tr>
                  `).join('') : '<tr><td colspan="4" class="empty-state">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="borrowSection" class="content-section ${currentTab === 'borrow' ? 'active' : ''}">
          <div class="card">
            <div class="academic-header"><h3>üß¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h3></div>
            <div class="table-container academic-table">
              <table>
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody>
                  ${myChemicalBorrows.length > 0 ? myChemicalBorrows.map(item => `
                    <tr>
                      <td><strong>${item.itemName}</strong>${item.issueReported ? '<br><small style="color: #d97706;">‚ö†Ô∏è ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</small>' : ''}</td>
                      <td>${item.amount}${item.issueReported ? `<br><small style="color: #6b7280;">‡πÄ‡∏î‡∏¥‡∏°: ${(parseFloat(item.amount) + parseFloat(item.issueAmount)).toFixed(2)}</small>` : ''}</td>
                      <td>${item.room}</td>
                      <td>${new Date(item.borrowDate).toLocaleDateString('th-TH')}</td>
                      <td>${item.returnDate ? new Date(item.returnDate).toLocaleDateString('th-TH') : '-'}</td>
                      <td><span class="badge ${item.status === 'returned' ? 'badge-returned' : 'badge-pending'}">${item.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô'}</span></td>
                      <td>
                        ${item.status === 'pending' ? `
                          <button class="btn btn-secondary btn-small" onclick='editBorrow(${JSON.stringify(item)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                          <button class="btn btn-success btn-small" onclick='returnItem(${JSON.stringify(item)})'>‡∏Ñ‡∏∑‡∏ô</button>
                          ${!item.issueReported ? `<button class="btn btn-danger btn-small" onclick='reportIssueFromBorrow(${JSON.stringify(item)})'>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</button>` : ''}
                        ` : '<span style="color: #9ca3af;">-</span>'}
                      </td>
                    </tr>
                  `).join('') : '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìù</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <div class="academic-header"><h3>üî¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3></div>
            <div class="table-container academic-table">
              <table>
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody>
                  ${myEquipmentBorrows.length > 0 ? myEquipmentBorrows.map(item => `
                    <tr>
                      <td><strong>${item.itemName}</strong>${item.issueReported ? '<br><small style="color: #d97706;">‚ö†Ô∏è ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</small>' : ''}</td>
                      <td>${item.amount}${item.issueReported ? `<br><small style="color: #6b7280;">‡πÄ‡∏î‡∏¥‡∏°: ${(parseFloat(item.amount) + parseFloat(item.issueAmount)).toFixed(0)}</small>` : ''}</td>
                      <td>${item.room}</td>
                      <td>${new Date(item.borrowDate).toLocaleDateString('th-TH')}</td>
                      <td>${item.returnDate ? new Date(item.returnDate).toLocaleDateString('th-TH') : '-'}</td>
                      <td><span class="badge ${item.status === 'returned' ? 'badge-returned' : 'badge-pending'}">${item.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô'}</span></td>
                      <td>
                        ${item.status === 'pending' ? `
                          <button class="btn btn-secondary btn-small" onclick='editBorrow(${JSON.stringify(item)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                          <button class="btn btn-success btn-small" onclick='returnItem(${JSON.stringify(item)})'>‡∏Ñ‡∏∑‡∏ô</button>
                          ${!item.issueReported ? `<button class="btn btn-danger btn-small" onclick='reportIssueFromBorrow(${JSON.stringify(item)})'>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</button>` : ''}
                        ` : '<span style="color: #9ca3af;">-</span>'}
                      </td>
                    </tr>
                  `).join('') : '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìù</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="historySection" class="content-section ${currentTab === 'history' ? 'active' : ''}">
          
          <div class="card">
            <div class="academic-header"><h3>üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h3></div>
            <div class="table-container academic-table">
              <table>
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                <tbody>
                  ${myChemicalBorrows.length > 0 ? myChemicalBorrows.map(item => `
                    <tr>
                      <td><strong>${item.itemName}</strong></td>
                      <td>${item.amount}</td>
                      <td>${item.room}</td>
                      <td>${new Date(item.borrowDate).toLocaleDateString('th-TH')}</td>
                      <td>${item.returnDate ? new Date(item.returnDate).toLocaleDateString('th-TH') : '-'}</td>
                      <td><span class="badge ${item.status === 'returned' ? 'badge-returned' : 'badge-pending'}">${item.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô'}</span></td>
                    </tr>
                  `).join('') : '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üìñ</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="academic-header"><h3>üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3></div>
            <div class="table-container academic-table">
              <table>
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                <tbody>
                  ${myEquipmentBorrows.length > 0 ? myEquipmentBorrows.map(item => `
                    <tr>
                      <td><strong>${item.itemName}</strong></td>
                      <td>${item.amount}</td>
                      <td>${item.room}</td>
                      <td>${new Date(item.borrowDate).toLocaleDateString('th-TH')}</td>
                      <td>${item.returnDate ? new Date(item.returnDate).toLocaleDateString('th-TH') : '-'}</td>
                      <td><span class="badge ${item.status === 'returned' ? 'badge-returned' : 'badge-pending'}">${item.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô'}</span></td>
                    </tr>
                  `).join('') : '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üìñ</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>

        </div>
        
      </div>
      <div id="modal" class="modal"></div>
    `;
  }

  function switchTab(tab) {
    currentTab = tab;
    renderDashboard();
  }

  function logout() {
    currentUser = null;
    currentView = 'login';
    currentTab = 'dashboard';
    allData = []; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    renderLogin();
  }
  
  function closeModal() {
    if(!modalElement) modalElement = document.getElementById('modal');
    if(modalElement) {
        modalElement.classList.remove('active');
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á clear innerHTML ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ animation
        setTimeout(() => {
             if (!modalElement.classList.contains('active')) {
                 modalElement.innerHTML = '';
             }
        }, 300);
    }
  }
  
  // [GAS CONVERSION] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á
  window.onclick = function(event) {
    if (event.target === modalElement) {
      closeModal();
    }
  };


  // === MODAL FUNCTIONS (Converted) ===

  function openAddChemicalModal() {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡πÉ‡∏´‡∏°‡πà</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="addChemicalForm">
          <div class="form-group"><label for="chemName">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ *</label><input type="text" id="chemName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°‡∏Ñ‡∏•‡∏≠‡πÑ‡∏£‡∏î‡πå"></div>
          <div class="form-group"><label for="chemFormula">‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</label><input type="text" id="chemFormula" placeholder="‡πÄ‡∏ä‡πà‡∏ô NaCl"></div>
          <div class="form-row">
            <div class="form-group"><label for="chemQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label><input type="number" id="chemQuantity" required min="0" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label for="chemUnit">‡∏´‡∏ô‡πà‡∏ß‡∏¢ *</label>
              <select id="chemUnit" required>
                <option value="mL">mL</option><option value="L">L</option><option value="g">g</option><option value="kg">kg</option>
                <option value="‡∏Ç‡∏ß‡∏î">‡∏Ç‡∏ß‡∏î</option><option value="‡∏≠‡∏±‡∏ô">‡∏≠‡∏±‡∏ô</option><option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option>
                <option value="‡∏´‡∏•‡∏≠‡∏î">‡∏´‡∏•‡∏≠‡∏î</option><option value="‡πÅ‡∏ó‡πà‡∏á">‡πÅ‡∏ó‡πà‡∏á</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label for="chemLocation">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö *</label><input type="text" id="chemLocation" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏π‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ A-1"></div>
          <div class="form-group"><label for="chemMinStock">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label><input type="number" id="chemMinStock" min="0" step="0.01" value="0" placeholder="0.00"></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('addChemicalForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const data = {
        id: 'chem-' + Date.now(),
        type: 'chemical',
        name: document.getElementById('chemName').value,
        formula: document.getElementById('chemFormula').value,
        quantity: parseFloat(document.getElementById('chemQuantity').value),
        unit: document.getElementById('chemUnit').value,
        location: document.getElementById('chemLocation').value,
        minStock: parseFloat(document.getElementById('chemMinStock').value) || 0,
        createdAt: new Date().toISOString()
      };
      createItem(data);
    });
  }
  
  function editChemical(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="editChemicalForm">
          <div class="form-group"><label for="chemName">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ *</label><input type="text" id="chemName" value="${item.name}" required></div>
          <div class="form-group"><label for="chemFormula">‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</label><input type="text" id="chemFormula" value="${item.formula || ''}"></div>
          <div class="form-row">
            <div class="form-group"><label for="chemQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label><input type="number" id="chemQuantity" value="${item.quantity}" required min="0" step="0.01"></div>
            <div class="form-group"><label for="chemUnit">‡∏´‡∏ô‡πà‡∏ß‡∏¢ *</label>
              <select id="chemUnit" required>
                <option value="mL" ${item.unit === 'mL' ? 'selected' : ''}>mL</option><option value="L" ${item.unit === 'L' ? 'selected' : ''}>L</option>
                <option value="g" ${item.unit === 'g' ? 'selected' : ''}>g</option><option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>kg</option>
                <option value="‡∏Ç‡∏ß‡∏î" ${item.unit === '‡∏Ç‡∏ß‡∏î' ? 'selected' : ''}>‡∏Ç‡∏ß‡∏î</option><option value="‡∏≠‡∏±‡∏ô" ${item.unit === '‡∏≠‡∏±‡∏ô' ? 'selected' : ''}>‡∏≠‡∏±‡∏ô</option>
                <option value="‡∏ä‡∏¥‡πâ‡∏ô" ${item.unit === '‡∏ä‡∏¥‡πâ‡∏ô' ? 'selected' : ''}>‡∏ä‡∏¥‡πâ‡∏ô</option><option value="‡∏´‡∏•‡∏≠‡∏î" ${item.unit === '‡∏´‡∏•‡∏≠‡∏î' ? 'selected' : ''}>‡∏´‡∏•‡∏≠‡∏î</option>
                <option value="‡πÅ‡∏ó‡πà‡∏á" ${item.unit === '‡πÅ‡∏ó‡πà‡∏á' ? 'selected' : ''}>‡πÅ‡∏ó‡πà‡∏á</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label for="chemLocation">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö *</label><input type="text" id="chemLocation" value="${item.location}" required></div>
          <div class="form-group"><label for="chemMinStock">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label><input type="number" id="chemMinStock" value="${item.minStock || 0}" min="0" step="0.01"></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('editChemicalForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const updatedItem = {
        ...item,
        name: document.getElementById('chemName').value,
        formula: document.getElementById('chemFormula').value,
        quantity: parseFloat(document.getElementById('chemQuantity').value),
        unit: document.getElementById('chemUnit').value,
        location: document.getElementById('chemLocation').value,
        minStock: parseFloat(document.getElementById('chemMinStock').value) || 0
      };
      updateItem(updatedItem);
    });
  }

  function openAddEquipmentModal() {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="addEquipmentForm">
          <div class="form-group"><label for="equipName">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå *</label><input type="text" id="equipName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏µ‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå"></div>
          <div class="form-row">
            <div class="form-group"><label for="equipQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label><input type="number" id="equipQuantity" required min="0" step="1" placeholder="0"></div>
            <div class="form-group"><label for="equipUnit">‡∏´‡∏ô‡πà‡∏ß‡∏¢ *</label>
              <select id="equipUnit" required>
                <option value="‡∏≠‡∏±‡∏ô">‡∏≠‡∏±‡∏ô</option><option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</option>
                <option value="‡∏ä‡∏∏‡∏î">‡∏ä‡∏∏‡∏î</option><option value="‡∏´‡∏•‡∏≠‡∏î">‡∏´‡∏•‡∏≠‡∏î</option><option value="‡πÅ‡∏ú‡πà‡∏ô">‡πÅ‡∏ú‡πà‡∏ô</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label for="equipLocation">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö *</label><input type="text" id="equipLocation" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏π‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå B-2"></div>
          <div class="form-group"><label for="equipMinStock">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label><input type="number" id="equipMinStock" min="0" step="1" value="0" placeholder="0"></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('addEquipmentForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const data = {
        id: 'equip-' + Date.now(),
        type: 'equipment',
        name: document.getElementById('equipName').value,
        quantity: parseInt(document.getElementById('equipQuantity').value),
        unit: document.getElementById('equipUnit').value,
        location: document.getElementById('equipLocation').value,
        minStock: parseInt(document.getElementById('equipMinStock').value) || 0,
        createdAt: new Date().toISOString()
      };
      createItem(data);
    });
  }

  function editEquipment(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="editEquipmentForm">
          <div class="form-group"><label for="equipName">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå *</label><input type="text" id="equipName" value="${item.name}" required></div>
          <div class="form-row">
            <div class="form-group"><label for="equipQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label><input type="number" id="equipQuantity" value="${item.quantity}" required min="0" step="1"></div>
            <div class="form-group"><label for="equipUnit">‡∏´‡∏ô‡πà‡∏ß‡∏¢ *</label>
              <select id="equipUnit" required>
                <option value="‡∏≠‡∏±‡∏ô" ${item.unit === '‡∏≠‡∏±‡∏ô' ? 'selected' : ''}>‡∏≠‡∏±‡∏ô</option><option value="‡∏ä‡∏¥‡πâ‡∏ô" ${item.unit === '‡∏ä‡∏¥‡πâ‡∏ô' ? 'selected' : ''}>‡∏ä‡∏¥‡πâ‡∏ô</option>
                <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" ${item.unit === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á' ? 'selected' : ''}>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</option><option value="‡∏ä‡∏∏‡∏î" ${item.unit === '‡∏ä‡∏∏‡∏î' ? 'selected' : ''}>‡∏ä‡∏∏‡∏î</option>
                <option value="‡∏´‡∏•‡∏≠‡∏î" ${item.unit === '‡∏´‡∏•‡∏≠‡∏î' ? 'selected' : ''}>‡∏´‡∏•‡∏≠‡∏î</option><option value="‡πÅ‡∏ú‡πà‡∏ô" ${item.unit === '‡πÅ‡∏ú‡πà‡∏ô' ? 'selected' : ''}>‡πÅ‡∏ú‡πà‡∏ô</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label for="equipLocation">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö *</label><input type="text" id="equipLocation" value="${item.location}" required></div>
          <div class="form-group"><label for="equipMinStock">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label><input type="number" id="equipMinStock" value="${item.minStock || 0}" min="0" step="1"></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('editEquipmentForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const updatedItem = {
        ...item,
        name: document.getElementById('equipName').value,
        quantity: parseInt(document.getElementById('equipQuantity').value),
        unit: document.getElementById('equipUnit').value,
        location: document.getElementById('equipLocation').value,
        minStock: parseInt(document.getElementById('equipMinStock').value) || 0
      };
      updateItem(updatedItem);
    });
  }

  function openAddUserModal() {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="addUserForm">
          <div class="form-row">
            <div class="form-group"><label for="userFirstName">‡∏ä‡∏∑‡πà‡∏≠ *</label><input type="text" id="userFirstName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢"></div>
            <div class="form-group"><label for="userLastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label><input type="text" id="userLastName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏à‡∏î‡∏µ"></div>
          </div>
          <div class="form-group"><label for="userName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label><input type="text" id="userName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô teacher01"></div>
          <div class="form-group"><label for="userPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô *</label>
            <div class="input-wrapper">
              <input type="password" id="userPassword" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
              <span class="eye-icon" onclick="toggleModalPassword()">üëÅÔ∏è</span>
            </div>
          </div>
          <div class="info-box"><p>üí° ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('addUserForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const data = {
        id: 'user-' + Date.now(),
        type: 'user',
        firstName: document.getElementById('userFirstName').value,
        lastName: document.getElementById('userLastName').value,
        username: document.getElementById('userName').value,
        password: document.getElementById('userPassword').value,
        role: 'teacher',
        createdAt: new Date().toISOString()
      };
      createItem(data);
    });
  }

  function editUser(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="editUserForm">
          <div class="form-row">
            <div class="form-group"><label for="userFirstName">‡∏ä‡∏∑‡πà‡∏≠ *</label><input type="text" id="userFirstName" value="${item.firstName || ''}" required></div>
            <div class="form-group"><label for="userLastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label><input type="text" id="userLastName" value="${item.lastName || ''}" required></div>
          </div>
          <div class="form-group"><label for="userName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label><input type="text" id="userName" value="${item.username}" required></div>
          <div class="form-group"><label for="userPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô *</label>
            <div class="input-wrapper">
              <input type="password" id="userPassword" value="${item.password}" required>
              <span class="eye-icon" onclick="toggleModalPassword()">üëÅÔ∏è</span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('editUserForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const updatedItem = {
        ...item,
        firstName: document.getElementById('userFirstName').value,
        lastName: document.getElementById('userLastName').value,
        username: document.getElementById('userName').value,
        password: document.getElementById('userPassword').value
      };
      updateItem(updatedItem);
    });
  }

  function toggleModalPassword() {
    const passwordInput = document.getElementById('userPassword');
    const eyeIcon = document.querySelector('.modal .eye-icon');
    if (!passwordInput || !eyeIcon) return;
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      eyeIcon.textContent = 'üôà';
    } else {
      passwordInput.type = 'password';
      eyeIcon.textContent = 'üëÅÔ∏è';
    }
  }

  function openBorrowModal() {
    const chemicals = allData.filter(item => item.type === 'chemical' && item.quantity > 0);
    const equipment = allData.filter(item => item.type === 'equipment' && item.quantity > 0);
    const allItems = [...chemicals, ...equipment];

    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="borrowForm">
          <div class="form-group">
            <label for="borrowItem">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ *</label>
            <select id="borrowItem" required onchange="updateMaxAmount()">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° --</option>
              ${allItems.map(item => `
                <option value="${item.__backendId}" data-quantity="${item.quantity}" data-name="${item.name}" data-type="${item.type}" data-unit="${item.unit}">
                  ${item.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.quantity} ${item.unit})
                </option>
              `).join('')}
            </select>
          </div>
          <div class="form-group"><label for="borrowAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏° *</label<input type="number" id="borrowAmount" required min="0.01" step="any" placeholder="0.00"></div>
          <div class="form-group"><label for="borrowRoom">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label><input type="text" id="borrowRoom" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πá‡∏ö‡πÄ‡∏Ñ‡∏°‡∏µ 1"></div>
          <div class="info-box"><p>üìù ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('borrowForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
      const select = document.getElementById('borrowItem');
      if (!select.value) {
          showErrorMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°');
          submitBtn.disabled = false;
          submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°';
          return;
      }
      const selectedOption = select.options[select.selectedIndex];
      const itemId = select.value;
      const itemName = selectedOption.dataset.name;
      const itemType = selectedOption.dataset.type;
      const amount = parseFloat(document.getElementById('borrowAmount').value);
      const room = document.getElementById('borrowRoom').value;

      const item = allData.find(i => i.__backendId === itemId);
      if (!item || item.quantity < amount) {
        showErrorMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠');
        submitBtn.disabled = false;
        submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°';
        return;
      }

      const borrowData = {
        id: 'borrow-' + Date.now(),
        type: 'borrow',
        borrower: currentUser.username,
        itemId: itemId,
        itemName: itemName,
        itemType: itemType,
        amount: amount,
        room: room,
        borrowDate: new Date().toISOString(),
        returnDate: null,
        status: 'pending',
        createdAt: new Date().toISOString()
      };
      
      const updatedItem = { ...item, quantity: item.quantity - amount };

      // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö
      google.script.run
        .withSuccessHandler(onBorrowSuccess) // <-- ‡πÉ‡∏ä‡πâ Handler ‡πÉ‡∏´‡∏°‡πà
        .withFailureHandler(onFailure)
        .handleBorrowItem(borrowData, updatedItem); // <-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
    });
  }

  function updateMaxAmount() {
    const select = document.getElementById('borrowItem');
    const selectedOption = select.options[select.selectedIndex];
    if (!select.value) return;
    
    const maxQuantity = parseFloat(selectedOption.dataset.quantity) || 0;
    const unit = selectedOption.dataset.type === 'chemical' ? '0.01' : '1';
    
    const amountInput = document.getElementById('borrowAmount');
    if (amountInput) {
        amountInput.max = maxQuantity;
        amountInput.step = unit;
        amountInput.placeholder = `‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${maxQuantity}`;
    }
  }

  function quickBorrowChemical(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="quickBorrowForm">
          <div class="info-box"><p>üìã ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ: ${item.name} (${item.formula || '-'}) | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.quantity} ${item.unit}</p></div>
          <div class="form-group"><label for="borrowAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏° *</label><input type="number" id="borrowAmount" required min="0.01" max="${item.quantity}" step="any" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${item.quantity}"></div>
          <div class="form-group"><label for="borrowRoom">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label><input type="text" id="borrowRoom" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πá‡∏ö‡πÄ‡∏Ñ‡∏°‡∏µ 1"></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ">‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('quickBorrowForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

  const amount = parseFloat(document.getElementById('borrowAmount').value);
  const room = document.getElementById('borrowRoom').value;

  if (amount > item.quantity) {
    showErrorMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠');
    submitBtn.disabled = false;
    submitBtn.textContent = '‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ';
    return;
  }

  const borrowData = {
    id: 'borrow-' + Date.now(),
    type: 'borrow',
    borrower: currentUser.username,
    itemId: item.__backendId,
    itemName: item.name,
    itemType: item.type,
    amount: amount,
    room: room,
    borrowDate: new Date().toISOString(),
    returnDate: null,
    status: 'pending',
    createdAt: new Date().toISOString()
  };

  const updatedItem = { ...item, quantity: item.quantity - amount };

  // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö
  google.script.run
    .withSuccessHandler(onBorrowSuccess) // <-- ‡πÉ‡∏ä‡πâ Handler ‡πÉ‡∏´‡∏°‡πà
    .withFailureHandler(onFailure)
    .handleBorrowItem(borrowData, updatedItem); // <-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
});
  }

  function quickBorrowEquipment(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="quickBorrowForm">
          <div class="info-box"><p>üìã ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${item.name} | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.quantity} ${item.unit}</p></div>
          <div class="form-group"><label for="borrowAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏° *</label><input type="number" id="borrowAmount" required min="1" max="${item.quantity}" step="any" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${item.quantity}"></div>
          <div class="form-group"><label for="borrowRoom">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label><input type="text" id="borrowRoom" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πá‡∏ö‡πÄ‡∏Ñ‡∏°‡∏µ 1"></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå">‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('quickBorrowForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
      const amount = parseInt(document.getElementById('borrowAmount').value);
      const room = document.getElementById('borrowRoom').value;

      if (amount > item.quantity) {
        showErrorMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠');
        submitBtn.disabled = false;
        submitBtn.textContent = '‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå';
        return;
      }

      const borrowData = {
        id: 'borrow-' + Date.now(),
        type: 'borrow',
        borrower: currentUser.username,
        itemId: item.__backendId,
        itemName: item.name,
        itemType: item.type,
        amount: amount,
        room: room,
        borrowDate: new Date().toISOString(),
        returnDate: null,
        status: 'pending',
        createdAt: new Date().toISOString()
      };

      const updatedItem = { ...item, quantity: item.quantity - amount };
      
      // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö
      google.script.run
        .withSuccessHandler(onBorrowSuccess) // <-- ‡πÉ‡∏ä‡πâ Handler ‡πÉ‡∏´‡∏°‡πà
        .withFailureHandler(onFailure)
        .handleBorrowItem(borrowData, updatedItem); // <-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
    });
  }

  function reportOutOfStock(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="reportOutOfStockForm">
          <div class="info-box"><p>üìã ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ: ${item.name} (${item.formula || '-'})</p></div>
          <div class="form-group"><label for="outOfStockAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î *</label><input type="number" id="outOfStockAmount" required min="0.01" step="0.01" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î"></div>
          <div class="form-group"><label for="outOfStockNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="outOfStockNote" rows="3" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö..."></textarea></div>
          <button type="submit" class="btn btn-danger" data-original-text="‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î">‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('reportOutOfStockForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏à‡πâ‡∏á...';
                
      const outOfStockAmount = parseFloat(document.getElementById('outOfStockAmount').value);
      const note = document.getElementById('outOfStockNote').value;

      const issueReport = {
        id: 'issue-' + Date.now(),
        type: 'issue_report',
        itemId: item.__backendId,
        itemName: item.name,
        itemType: item.type,
        issueType: 'out_of_stock',
        reportedBy: currentUser.username,
        reportDate: new Date().toISOString(),
        originalAmount: outOfStockAmount,
        note: note,
        status: 'reported',
        createdAt: new Date().toISOString()
      };

      const updatedItem = {
        ...item,
        quantity: Math.max(0, item.quantity - outOfStockAmount)
      };

      google.script.run
        .withSuccessHandler(response => {
          if (!response.success) return onFailure(new Error('Failed to create issue report'));
          console.log('Issue report created. Updating item stock...');
          updateItem(updatedItem); 
        })
        .withFailureHandler(onFailure)
        .handleCreate(issueReport);
    });
  }

  // --- [GAS CONVERSION] ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß) ---

  function reportDamaged(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="reportDamagedForm">
          <div class="info-box"><p>üìã ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${item.name} | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.quantity} ${item.unit}</p></div>
          <div class="form-group"><label for="damagedAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î *</label><input type="number" id="damagedAmount" required min="1" step="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î"></div>
          <div class="form-group"><label for="damagedNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</label><textarea id="damagedNote" rows="3" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏û‡∏ö..."></textarea></div>
          <button type="submit" class="btn btn-danger" data-original-text="‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î">‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('reportDamagedForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏à‡πâ‡∏á...';
                
      const damagedAmount = parseFloat(document.getElementById('damagedAmount').value);
      const note = document.getElementById('damagedNote').value;
      
      if (damagedAmount > item.quantity) {
          showErrorMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠');
          submitBtn.disabled = false;
          submitBtn.textContent = '‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î';
          return;
      }

      const issueReport = {
        id: 'issue-' + Date.now(),
        type: 'issue_report',
        itemId: item.__backendId,
        itemName: item.name,
        itemType: item.type,
        issueType: 'damaged',
        reportedBy: currentUser.username,
        reportDate: new Date().toISOString(),
        damagedAmount: damagedAmount,
        note: note,
        status: 'reported',
        createdAt: new Date().toISOString()
      };

      const updatedItem = {
        ...item,
        quantity: Math.max(0, item.quantity - damagedAmount),
        damagedQuantity: (item.damagedQuantity || 0) + damagedAmount,
        status: item.quantity - damagedAmount > 0 ? item.status : 'damaged', // [FIX] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï status
        damageNote: note
      };

      google.script.run
        .withSuccessHandler(response => {
          if (!response.success) return onFailure(new Error('Failed to create issue report'));
          console.log('Issue report created. Updating item status...');
          updateItem(updatedItem);
        })
        .withFailureHandler(onFailure)
        .handleCreate(issueReport);
    });
  }

  function reportIssueFromBorrow(borrowItem) {
    const item = allData.find(i => i.__backendId === borrowItem.itemId);
    if (!item) return;

    if(!modalElement) modalElement = document.getElementById('modal');
    const buttonText = item.type === 'chemical' ? '‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î' : '‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢';
    const issueTypeText = item.type === 'chemical' ? '‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î' : '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢';
    const step = item.type === 'chemical' ? '0.01' : '1';
            
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>${buttonText}: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="reportIssueForm">
          <div class="info-box"><p>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°: ${item.name} | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${borrowItem.amount} ${item.unit}</p></div>
          <div class="form-group">
            <label for="issueAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà${issueTypeText} *</label>
            <input type="number" id="issueAmount" required min="${step}" max="${borrowItem.amount}" step="${step}" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà${issueTypeText}" oninput="updateRemainingAmount(${borrowItem.amount}, ${item.type === 'chemical' ? 2 : 0})">
          </div>
          <div class="info-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b;">
            <p id="remainingInfo">üí° ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô: <span id="remainingAmount">${borrowItem.amount}</span> ${item.unit}</p>
          </div>
          <div class="form-group"><label for="issueNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label><textarea id="issueNote" rows="3" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö..."></textarea></div>
          <button type="submit" class="btn btn-danger" data-original-text="${buttonText}">${buttonText}</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');
  
    // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateRemainingAmount ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    window.updateRemainingAmount = (originalAmount, decimals) => {
        const issueAmount = parseFloat(document.getElementById('issueAmount').value) || 0;
        const remaining = Math.max(0, originalAmount - issueAmount);
        document.getElementById('remainingAmount').textContent = remaining.toFixed(decimals);
    };

    document.getElementById('reportIssueForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏à‡πâ‡∏á...';
                
      const issueAmount = parseFloat(document.getElementById('issueAmount').value);
      const note = document.getElementById('issueNote').value;
      const remainingAmount = Math.max(0, borrowItem.amount - issueAmount);
      
      if (issueAmount > borrowItem.amount) {
          showErrorMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°');
          submitBtn.disabled = false;
          submitBtn.textContent = buttonText;
          return;
      }

      const issueReport = {
        id: 'issue-' + Date.now(),
        type: 'issue_report',
        itemId: item.__backendId,
        itemName: item.name,
        itemType: item.type,
        issueType: item.type === 'chemical' ? 'out_of_stock' : 'damaged',
        reportedBy: currentUser.username,
        reportDate: new Date().toISOString(),
        borrowId: borrowItem.__backendId,
        originalAmount: borrowItem.amount,
        [item.type === 'chemical' ? 'outOfStockAmount' : 'damagedAmount']: issueAmount,
        note: note,
        status: 'reported',
        createdAt: new Date().toISOString()
      };

      const updatedBorrow = {
        ...borrowItem,
        amount: remainingAmount,
        issueReported: true,
        issueAmount: issueAmount,
        issueNote: note
      };

      google.script.run
        .withSuccessHandler(response => {
          if (!response.success) return onFailure(new Error('Failed to create issue report'));
          console.log('Issue report created. Updating borrow record...');
          updateItem(updatedBorrow);
        })
        .withFailureHandler(onFailure)
        .handleCreate(issueReport);
    });
  }

  function editBorrow(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="editBorrowForm">
          <div class="form-group"><label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</label><input type="text" value="${item.itemName}" disabled></div>
          <div class="form-group">
            <label for="editAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏° *</label>
            <input type="number" id="editAmount" value="${item.amount}" required min="0.01" step="any">
          </div>
          <div class="form-group"><label for="editRoom">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label><input type="text" id="editRoom" value="${item.room}" required></div>
          <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</label><input type="text" value="${new Date(item.borrowDate).toLocaleString('th-TH')}" disabled></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('editBorrowForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
      const newAmount = parseFloat(document.getElementById('editAmount').value);
      const originalAmount = item.amount;
      const difference = newAmount - originalAmount;
      
      const updatedBorrow = {
        ...item,
        amount: newAmount,
        room: document.getElementById('editRoom').value
      };

      if (difference === 0) {
        updateItem(updatedBorrow);
        return;
      }
      
      const currentItem = allData.find(i => i.__backendId === item.itemId);
      if (!currentItem) {
          showErrorMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å');
          submitBtn.disabled = false;
          submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
          return;
      }

      if (difference > 0 && currentItem.quantity < difference) {
        showErrorMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏∑‡∏°');
        submitBtn.disabled = false;
        submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
        return;
      }

      const updatedItem = {
        ...currentItem,
        quantity: currentItem.quantity - difference // (‡∏•‡∏ö positive = ‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å, ‡∏•‡∏ö negative = ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å)
      };

      google.script.run
        .withSuccessHandler(response => {
            if (!response.success) return onFailure(new Error('Failed to update item stock'));
            console.log('Item stock updated. Updating borrow record...');
            updateItem(updatedBorrow);
        })
        .withFailureHandler(onFailure)
        .handleUpdate(updatedItem);
    });
  }

  function returnItem(borrow) {
    const item = allData.find(i => i.__backendId === borrow.itemId);
    if (!item) return;

    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="returnForm">
          <div class="info-box"><p>üìã ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°: ${borrow.amount} ${item.unit}</p></div>
          <div class="form-group">
            <label for="returnAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô *</label>
            <input type="number" id="returnAmount" value="${borrow.amount}" required min="0" max="${borrow.amount}" step="any" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô">
          </div>
          <div class="form-group"><label for="returnNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</label><textarea id="returnNote" rows="2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)..."></textarea></div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" class="btn btn-success" data-original-text="‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          </div>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('returnForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
      const returnAmount = parseFloat(document.getElementById('returnAmount').value);
      const returnNote = document.getElementById('returnNote').value;

      const updatedBorrow = {
        ...borrow,
        returnDate: new Date().toISOString(),
        status: 'returned',
        actualReturnAmount: returnAmount,
        returnNote: returnNote
      };

      const updatedItem = {
        ...item,
        quantity: item.quantity + returnAmount
      };

      google.script.run
        .withSuccessHandler(response => {
            if (!response.success) return onFailure(new Error('Failed to update borrow record'));
            console.log('Borrow record returned. Updating item stock...');
            updateItem(updatedItem);
        })
        .withFailureHandler(onFailure)
        .handleUpdate(updatedBorrow);
    });
  }

  function showErrorMessage(message) {
    const existingError = document.querySelector('.error-toast');
    if(existingError) document.body.removeChild(existingError);
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message error-toast';
    errorDiv.textContent = `‚ùå ${message}`;
    errorDiv.style.position = 'fixed';
    errorDiv.style.top = '20px';
    errorDiv.style.right = '20px';
    errorDiv.style.zIndex = '9999';
    errorDiv.style.maxWidth = '300px';
    errorDiv.style.boxShadow = '0 10px 20px rgba(0,0,0,0.1)';
    
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
      if (errorDiv.parentNode && errorDiv.parentNode === document.body) {
        document.body.removeChild(errorDiv);
      }
    }, 5000);
  }

  // --- Filter Functions (pure JS) ---
  
  // --- Filter Functions (pure JS) ---

  /**
   * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Reports ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)
   */
  function filterRows(tableId, searchTerm) {
      const table = document.getElementById(tableId);
      if (!table) return;
      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      let found = false;

      for (let row of rows) {
          if (row.classList.contains('empty-state')) continue;
          const text = row.textContent.toLowerCase(); // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß
          if (text.includes(searchTerm)) {
              row.style.display = '';
              found = true;
          } else {
              row.style.display = 'none';
          }
      }
      
      const emptyStateRow = table.querySelector('.empty-state');
      if (emptyStateRow) {
          emptyStateRow.style.display = found ? 'none' : 'table-row';
      }
  }

  /**
   * [‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠" (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å)
   */
  function filterByName(tableId, inputId) {
      const searchTerm = document.getElementById(inputId).value.toLowerCase();
      const table = document.getElementById(tableId);
      if (!table) return;
      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      let found = false;

      for (let row of rows) {
          if (row.classList.contains('empty-state')) continue;
          
          // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å (td[0])
          const cell = row.getElementsByTagName('td')[0]; 
          const text = cell ? cell.textContent.toLowerCase() : '';
          
          if (text.includes(searchTerm)) {
              row.style.display = '';
              found = true;
          } else {
              row.style.display = 'none';
          }
      }
      const emptyStateRow = table.querySelector('.empty-state');
      if (emptyStateRow) emptyStateRow.style.display = found ? 'none' : 'table-row';
  }

  // --- ‡∏ä‡∏µ‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Helper ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ---

  function filterReports() {
    const searchTerm = document.getElementById('reportSearch').value.toLowerCase();
    filterRows('reportsTable', searchTerm); // ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
  }

  function filterChemicals() {
    filterByName('chemicalsTable', 'chemicalSearch'); // ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ Admin (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠)
  }
  function filterEquipment() {
    filterByName('equipmentTable', 'equipmentSearch'); // ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå Admin (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠)
  }
  function filterTeacherChemicals() {
    filterByName('teacherChemicalsTable', 'chemicalSearchTeacher'); // ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ ‡∏Ñ‡∏£‡∏π (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠)
  }
  function filterTeacherEquipment() {
    filterByName('teacherEquipmentTable', 'equipmentSearchTeacher'); // ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡∏Ñ‡∏£‡∏π (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏∑‡πà‡∏≠)
  }

  // --- Report Resolution Functions (Converted) ---
  
  function resolveChemicalIssue(report, item) {
    if (!report || !item) {
        showErrorMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        return;
    }

    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="restockForm">
          <div class="info-box"><p>üìã ‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ${report.reportedBy} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ${new Date(report.reportDate).toLocaleDateString('th-TH')}</p></div>
          <div class="form-group"><label for="restockAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏° *</label><input type="number" id="restockAmount" required min="0.01" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label for="restockNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</label><textarea id="restockNote" rows="2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å..."></textarea></div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" class="btn btn-success" data-original-text="‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å">‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
          </div>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('restockForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
      const restockAmount = parseFloat(document.getElementById('restockAmount').value);
      const restockNote = document.getElementById('restockNote').value;
      
      const updatedItem = {
        ...item,
        quantity: item.quantity + restockAmount
      };
      
      const resolvedReport = {
        ...report,
        status: 'resolved',
        resolvedDate: new Date().toISOString(),
        resolvedNote: restockNote,
        restockAmount: restockAmount
      };
      
      google.script.run
        .withSuccessHandler(response => {
            if (!response.success) return onFailure(new Error('Failed to update item stock'));
            console.log('Item stock updated. Resolving report...');
            updateItem(resolvedReport);
        })
        .withFailureHandler(onFailure)
        .handleUpdate(updatedItem);
    });
  }

  function markIssueResolved(report) {
    if (!report) return;
    const resolvedReport = {
      ...report,
      status: 'resolved',
      resolvedDate: new Date().toISOString()
    };
    updateItem(resolvedReport);
  }

  function resolveEquipmentIssue(report, item) {
    if (!report || !item) {
        showErrorMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        return;
    }
    const damagedAmount = report.damagedAmount || 0;

    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="repairForm">
          <div class="info-box"><p>üìã ‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ${report.reportedBy} | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î: ${damagedAmount} ${item.unit}</p></div>
          <div class="form-group">
            <label for="repairedAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ *</label>
            <input type="number" id="repairedAmount" required min="0" max="${damagedAmount}" step="1" value="${damagedAmount}">
          </div>
          <div class="form-group"><label for="repairNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°</label><textarea id="repairNote" rows="2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°..."></textarea></div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" class="btn btn-success" data-original-text="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</button>
          </div>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('repairForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
      const repairedAmount = parseFloat(document.getElementById('repairedAmount').value);
      const repairNote = document.getElementById('repairNote').value;
      
      const updatedItem = {
        ...item,
        quantity: item.quantity + repairedAmount,
        damagedQuantity: Math.max(0, (item.damagedQuantity || 0) - repairedAmount)
      };
      
      if (updatedItem.damagedQuantity === 0) {
        updatedItem.status = 'normal';
        updatedItem.damageNote = '';
      }
      
      const resolvedReport = {
        ...report,
        status: 'resolved',
        resolvedDate: new Date().toISOString(),
        resolvedNote: repairNote,
        repairedAmount: repairedAmount
      };
      
      google.script.run
        .withSuccessHandler(response => {
            if (!response.success) return onFailure(new Error('Failed to update item stock'));
            console.log('Item stock updated. Resolving report...');
            updateItem(resolvedReport);
        })
        .withFailureHandler(onFailure)
        .handleUpdate(updatedItem);
    });
  }
  
  function viewEquipmentDetails(itemId) {
    const item = allData.find(i => i.__backendId === itemId);
    if (!item) return;

    const damageReports = allData.filter(report => 
      report.type === 'issue_report' && 
      report.itemId === itemId && 
      report.issueType === 'damaged' && 
      report.status !== 'resolved'
    );
            
    const totalReportedDamage = damageReports.reduce((sum, report) => sum + (report.damagedAmount || 0), 0);

    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${item.name}</h3>
          <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <div style="padding: 20px 0;">
          <div class="info-box" style="margin-bottom: 16px;">
            <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö):</strong> ${item.quantity + totalReportedDamage} ${item.unit}</p>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div>
              <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ:</label>
              <div style="font-size: 18px; font-weight: 600; color: #059669;">${item.quantity} ${item.unit}</div>
            </div>
            <div>
              <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î (‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°):</label>
              <div style="font-size: 18px; font-weight: 600; color: #dc2626;">${totalReportedDamage} ${item.unit}</div>
            </div>
          </div>
                        
          ${damageReports.length > 0 ? `
            <div style="margin-bottom: 20px;">
              <label style="font-weight: 600; margin-bottom: 8px; display: block;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∏‡∏î:</label>
              <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; max-height: 150px; overflow-y: auto;">
                ${damageReports.map(report => `
                  <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #fed7d7;">
                    <div style="font-size: 14px;">
                      <strong>‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</strong> ${report.reportedBy} | 
                      <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(report.reportDate).toLocaleDateString('th-TH')} |
                      <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> <span style="color: #dc2626; font-weight: 600;">${report.damagedAmount} ${item.unit}</span>
                    </div>
                    ${report.note ? `<div style="font-size: 13px; color: #6b7280; margin-top: 4px;"><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${report.note}</div>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
                        
          <div style="margin-bottom: 16px;"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö:</label><div>${item.location}</div></div>
          <div style="margin-bottom: 16px;"><label>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥:</label><div>${item.minStock || 0} ${item.unit}</div></div>
        </div>
        <div style="text-align: center;"><button class="btn btn-secondary" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button></div>
      </div>
    `;
    modalElement.classList.add('active');
  }

  // --- Download Functions (Converted) ---

  function downloadBorrowReport(format) {
    const borrows = allData.filter(item => item.type === 'borrow');
    const reportData = borrows.map(item => ({
      '‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°': item.borrower,
      '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': item.itemName,
      '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': item.amount,
      '‡∏´‡πâ‡∏≠‡∏á': item.room,
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°': new Date(item.borrowDate).toLocaleDateString('th-TH'),
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô': item.returnDate ? new Date(item.returnDate).toLocaleDateString('th-TH') : '-',
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': item.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô'
    }));
    const filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
    if (format === 'excel') downloadExcel(reportData, filename);
    else if (format === 'pdf') downloadPDF(reportData, '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô', filename);
  }

  function downloadInventoryReport(type, format) {
    const chemicals = allData.filter(item => item.type === 'chemical');
    const equipment = allData.filter(item => item.type === 'equipment');
    let allItems = [...chemicals, ...equipment];
    let reportData = [];
    let title = '';
    let filename = '';

    switch (type) {
      case 'all':
        reportData = allItems.map(item => ({
          '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': item.type === 'chemical' ? '‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ' : '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
          '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': item.name,
          '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.formula || '-',
          '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity,
          '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit,
          '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö': item.location,
          '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': item.minStock || 0,
          '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': item.quantity <= (item.minStock || 0) ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥' : '‡∏õ‡∏Å‡∏ï‡∏¥'
        }));
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        break;
      case 'available':
        const availableItems = allItems.filter(item => item.quantity > 0);
        reportData = availableItems.map(item => ({
          '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': item.type === 'chemical' ? '‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ' : '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
          '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': item.name,
          '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.formula || '-',
          '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity,
          '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit,
          '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö': item.location
        }));
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        break;
      case 'reorder':
        const reorderItems = allItems.filter(item => item.quantity <= (item.minStock || 0));
        reportData = reorderItems.map(item => ({
          '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': item.type === 'chemical' ? '‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ' : '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
          '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': item.name,
          '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity,
          '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit,
          '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': item.minStock || 0,
          '‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢)': Math.max(0, (item.minStock || 0) - item.quantity + 1)
        }));
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        break;
    }
    
    if (reportData.length === 0) {
        showErrorMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
        return;
    }
    if (format === 'excel') downloadExcel(reportData, filename);
    else if (format === 'pdf') downloadPDF(reportData, title, filename);
  }

  function downloadExcel(data, filename) {
    if (data.length === 0) {
      showErrorMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
      return;
    }
    const headers = Object.keys(data[0]);
    const csvContent = [
      headers.join(','),
      ...data.map(row => headers.map(header => {
        const value = row[header];
        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
          return `"${value.replace(/"/g, '""')}"`;
        }
        return value;
      }).join(','))
    ].join('\n');
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `${filename}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function downloadPDF(data, title, filename) {
    if (data.length === 0) {
      showErrorMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
      return;
    }
    
    // [GAS CONVERSION] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å window.elementSdk.config ‡πÄ‡∏õ‡πá‡∏ô defaultConfig
    const systemTitle = defaultConfig.system_title;
    const headers = Object.keys(data[0]);
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <!DOCTYPE html>
      <html lang="th">
      <head>
          <meta charset="UTF-8">
          <title>${title}</title>
          <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
          <style>
              @page { size: A4 landscape; margin: 1cm; }
              body { font-family: 'Sarabun', Arial, sans-serif; font-size: 12px; line-height: 1.4; margin: 0; padding: 20px; }
              .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #93c5fd; padding-bottom: 15px; }
              .header h1 { margin: 0; color: #1f2937; font-size: 18px; font-weight: 600; }
              .header h2 { margin: 5px 0 0 0; color: #60a5fa; font-size: 16px; font-weight: 500; }
              .info { text-align: right; margin-bottom: 20px; color: #6b7280; font-size: 11px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 10px; }
              th, td { border: 1px solid #e5e7eb; padding: 6px 4px; text-align: left; vertical-align: top; word-break: break-word; }
              th { background-color: #93c5fd; color: white; font-weight: 600; text-align: center; }
              tr:nth-child(even) { background-color: #f8fafc; }
              .footer { margin-top: 30px; text-align: center; color: #9ca3af; font-size: 10px; border-top: 1px solid #e5e7eb; padding-top: 10px; }
              @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
          </style>
      </head>
      <body>
          <div class="header">
              <h1>${systemTitle}</h1>
              <h2>${title}</h2>
          </div>
          <div class="info">
              ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: ${new Date().toLocaleString('th-TH')} | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          </div>
          <table>
              <thead>
                  <tr>${headers.map(header => `<th>${header}</th>`).join('')}</tr>
              </thead>
              <tbody>
                  ${data.map(row => `
                      <tr>${headers.map(header => `<td>${row[header]}</td>`).join('')}</tr>
                  `).join('')}
              </tbody>
          </table>
          <div class="footer">
              ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ ${systemTitle} | ‡∏´‡∏ô‡πâ‡∏≤ 1 ‡∏à‡∏≤‡∏Å 1
          </div>
      </body>
      </html>
    `);
    
    printWindow.document.close();
    printWindow.onload = function() {
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    };
  }
  
  // [GAS CONVERSION] ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å init() ‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≠‡∏Å
  // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ document.addEventListener('DOMContentLoaded', init); ‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß
  
</script>
 </body>
</html>
